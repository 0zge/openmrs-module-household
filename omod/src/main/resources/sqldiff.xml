<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqldiff PUBLIC "-//OpenMRS//DTD OpenMRS SQL Diff Config 1.0//EN" "http://resources.openmrs.org/doctype/sqldiff-1.0.dtd">

<sqldiff version="1.0">
	<diff>
		<version>1.0.0</version>
		<author>Ampath Developers</author>
		<date>April 24, 2011</date>
		<description>
			Create tables for Household System
			drop table `household_membership`, `household`,`household_definition`
		</description>
		<sql>
			Drop TABLE IF EXISTS `household_obs`,`household_encounter`,`household_encounter_type`,`household_location`,`household_location_entry`,`household_location_level`,`household_attrib_value`,`household_attribute`;
			Drop TABLE IF EXISTS `household_membership`, `household`,`household_definition`;
			CREATE TABLE `household_definition` (
				`household_definition_id` int(10) NOT NULL auto_increment,
				`household_definition_code` varchar(45) NOT NULL,
				`household_definition_codeinfull` varchar(255) DEFAULT NULL,
				`household_definition_description` varchar(255) DEFAULT NULL,
				`uuid` char(38) NOT NULL,
				`program_id` int(11) DEFAULT '0',
				`voided` smallint(6) NOT NULL DEFAULT '0',
				`voided_by` int(11) DEFAULT NULL,
				`date_voided` datetime DEFAULT NULL,
				`void_reason` varchar(255) DEFAULT NULL,
				`creator` int(11) NOT NULL DEFAULT '0',
				`date_created` datetime DEFAULT NULL,
				`date_changed` datetime DEFAULT NULL,
				`changed_by` int(11) DEFAULT NULL,
				PRIMARY KEY (`household_definition_id`),
				UNIQUE KEY `hduuid` (`uuid`),
				KEY `user_who_created_definitions` (`creator`),
				KEY `user_who_changed_definitions` (`changed_by`),
				KEY `user_who_voided_definitions` (`voided_by`),
				KEY `definition_program` (`program_id`),
				CONSTRAINT `user_who_created_definitions` FOREIGN KEY (`creator`) REFERENCES `users` (`user_id`),
				CONSTRAINT `user_who_changed_definitions` FOREIGN KEY (`changed_by`) REFERENCES `users` (`user_id`),
				CONSTRAINT `user_who_voided_definitions` FOREIGN KEY (`voided_by`) REFERENCES `users` (`user_id`),
				CONSTRAINT `definition_program` FOREIGN KEY (`program_id`) REFERENCES `program` (`program_id`)
			) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8;
			
			CREATE TABLE `household` (
				`household_group_id` int(10) NOT NULL auto_increment,
				`household_def_uuid` char(38) NOT NULL,
				`household_identifier` varchar(50) DEFAULT NULL,
				`uuid` char(38) NOT NULL,
				`voided` smallint(6) NOT NULL DEFAULT '0',
				`voided_by` int(11) DEFAULT NULL,
				`date_voided` datetime DEFAULT NULL,
				`void_reason` varchar(255) DEFAULT NULL,
				`creator` int(11) NOT NULL DEFAULT '0',
				`date_created` datetime DEFAULT NULL,
				`date_changed` datetime DEFAULT NULL,
				`changed_by` int(11) DEFAULT NULL,
				PRIMARY KEY (`household_group_id`),
				KEY `hhuuid` (`uuid`),
				KEY `household_def_uuid` (`household_def_uuid`),
				KEY `user_who_changed_household` (`changed_by`),
				KEY `user_who_created_household` (`creator`),
				KEY `user_who_voided_household` (`voided_by`),
				CONSTRAINT `user_who_created_household` FOREIGN KEY (`creator`) REFERENCES `users` (`user_id`),
                CONSTRAINT `user_who_changed_household` FOREIGN KEY (`changed_by`) REFERENCES `users` (`user_id`),
                CONSTRAINT `user_who_voided_household` FOREIGN KEY (`voided_by`) REFERENCES `users` (`user_id`),
                CONSTRAINT `household_def_uuid` FOREIGN KEY (`household_def_uuid`) REFERENCES `household_definition` (`uuid`)
			) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;
			
			CREATE TABLE `household_membership` (
	                `household_membership_id` int(10) NOT NULL auto_increment,
	                `household_uuid` char(38) NOT NULL,
	                `household_membership_headship` smallint(6) NOT NULL DEFAULT '0',
	                `household_membership_person_uuid` varchar(38) NOT NULL,
	                `start_date` datetime DEFAULT NULL,
	                `end_date` datetime DEFAULT NULL,
	                `voided` smallint(6) NOT NULL DEFAULT '0',
	                `voided_by` int(11) DEFAULT NULL,
	                `date_voided` datetime DEFAULT NULL,
	                `void_reason` varchar(255) DEFAULT NULL,
	                `creator` int(11) NOT NULL DEFAULT '0',
	                `date_created` datetime DEFAULT NULL,
	                `date_changed` datetime DEFAULT NULL,
	                `changed_by` int(11) DEFAULT NULL,
	                PRIMARY KEY (`household_membership_id`),
	                KEY `user_who_created_membership` (`creator`),
	                KEY `user_who_changed_membership` (`changed_by`),
	                KEY `user_who_voided_membership` (`voided_by`),
	                KEY `household_membership_person_uuid` (`household_membership_person_uuid`),
	                KEY `household_uuid` (`household_uuid`),
	                CONSTRAINT `household_uuid` FOREIGN KEY (`household_uuid`) REFERENCES `household` (`uuid`),
	                CONSTRAINT `user_who_created_membership` FOREIGN KEY (`creator`) REFERENCES `users` (`user_id`),
	                CONSTRAINT `user_who_changed_membership` FOREIGN KEY (`changed_by`) REFERENCES `users` (`user_id`),
	                CONSTRAINT `user_who_voided_membership` FOREIGN KEY (`voided_by`) REFERENCES `users` (`user_id`),
	                CONSTRAINT `household_membership_person_uuid` FOREIGN KEY (`household_membership_person_uuid`) REFERENCES `person` (`uuid`)
	        ) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8;
		</sql>
	</diff>
	<diff>
		<version>1.0.1</version>
		<author>Ampath Developers</author>
		<date>May 23, 2011</date>
		<description>
			Create data tables for Household System
			#To Drop : Drop TABLE `household_obs`,`household_encounter`,`household_encounter_type`,`household_location`,`household_location_entry`,`household_location_level`,`household_attrib_value`,`household_attribute`
		</description>
		<sql>
			Drop TABLE IF EXISTS `household_obs`,`household_encounter`,`household_encounter_type`,`household_location`,`household_location_entry`,`household_location_level`,`household_attrib_value`,`household_attribute`;
				
			CREATE TABLE `household_attribute` (
				`household_attribute_type_id` int(11) NOT NULL AUTO_INCREMENT,
				`name` varchar(50) NOT NULL DEFAULT '',
				`household_description` text NOT NULL,
				`searchable` smallint(6) NOT NULL DEFAULT '0',
				`creator` int(11) NOT NULL DEFAULT '0',
				`date_created` datetime NOT NULL DEFAULT '0002-11-30 00:00:00',
				`changed_by` int(11) DEFAULT NULL,
				`date_changed` datetime DEFAULT NULL,
				`retired` smallint(6) NOT NULL DEFAULT '0',
				`retired_by` int(11) DEFAULT NULL,
				`date_retired` datetime DEFAULT NULL,
				`retire_reason` varchar(255) DEFAULT NULL,
				`edit_privilege` varchar(255) DEFAULT NULL,
				`uuid` char(38) NOT NULL,
				`sort_weight` double DEFAULT NULL,
				PRIMARY KEY (`household_attribute_type_id`),
				UNIQUE KEY `household_attribute_type_uuid_index` (`uuid`),
				KEY `household_attribute_is_searchable` (`searchable`),
				KEY `household_name_of_attribute` (`name`),
				KEY `household_attribute_type_retired_status` (`retired`),
				KEY `household_attribute_type_changer` (`changed_by`),
				KEY `household_attribute_type_creator` (`creator`),
				KEY `household_user_who_retired_household_attribute_type` (`retired_by`),
				KEY `household_privilege_which_can_edit` (`edit_privilege`),
				CONSTRAINT `household_attribute_type_changer` FOREIGN KEY (`changed_by`) REFERENCES `users` (`user_id`),
				CONSTRAINT `household_attribute_type_creator` FOREIGN KEY (`creator`) REFERENCES `users` (`user_id`),
				CONSTRAINT `household_privilege_which_can_edit` FOREIGN KEY (`edit_privilege`) REFERENCES `privilege` (`privilege`),
				CONSTRAINT `household_user_who_retired_household_attribute_type` FOREIGN KEY (`retired_by`) REFERENCES `users` (`user_id`)
			) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8;
			
			CREATE TABLE `household_attrib_value` (
				`household_attribute_id` int(11) NOT NULL AUTO_INCREMENT,
				`household_group_uuid` char(38) DEFAULT NULL,
				`household_value` varchar(50) NOT NULL DEFAULT '',
				`household_attribute_type_id` int(11) NOT NULL DEFAULT '0',
				`creator` int(11) NOT NULL DEFAULT '0',
				`date_created` datetime NOT NULL DEFAULT '0002-11-30 00:00:00',
				`changed_by` int(11) DEFAULT NULL,
				`date_changed` datetime DEFAULT NULL,
				`voided` smallint(6) NOT NULL DEFAULT '0',
				`voided_by` int(11) DEFAULT NULL,
				`date_voided` datetime DEFAULT NULL,
				`void_reason` varchar(255) DEFAULT NULL,
				`uuid` char(38) NOT NULL,
				PRIMARY KEY (`household_attribute_id`),
				UNIQUE KEY `household_attribute_uuid_index` (`uuid`),
				KEY `household_attribute_changer` (`changed_by`),
				KEY `household_attribute_creator` (`creator`),
				KEY `household_defines_attribute_type` (`household_attribute_type_id`),
				KEY `identifies_household` (`household_group_uuid`),
				KEY `household_attribute_voider` (`voided_by`),
				CONSTRAINT `household_attribute_changer` FOREIGN KEY (`changed_by`) REFERENCES `users` (`user_id`),
				CONSTRAINT `household_attribute_creator` FOREIGN KEY (`creator`) REFERENCES `users` (`user_id`),
				CONSTRAINT `household_attribute_voider` FOREIGN KEY (`voided_by`) REFERENCES `users` (`user_id`),
				CONSTRAINT `household_defines_attribute_type` FOREIGN KEY (`household_attribute_type_id`) REFERENCES `household_attribute` (`household_attribute_type_id`),
				CONSTRAINT `identifies_household` FOREIGN KEY (`household_group_uuid`) REFERENCES `household` (`uuid`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE `household_location` (
			  `household_location_id` int(11) NOT NULL AUTO_INCREMENT,
			  `name` varchar(255) NOT NULL DEFAULT '',
			  `description` varchar(255) DEFAULT NULL,
			  `address1` varchar(255) DEFAULT NULL,
			  `address2` varchar(255) DEFAULT NULL,
			  `address3` varchar(255) DEFAULT NULL,
			  `address4` varchar(255) DEFAULT NULL,
			  `address5` varchar(255) DEFAULT NULL,
			  `address6` varchar(255) DEFAULT NULL,
			  `city_village` varchar(255) DEFAULT NULL,
			  `city_sub_location` varchar(255) DEFAULT NULL,
			  `city_location` varchar(255) DEFAULT NULL,
			  `county_district` varchar(255) DEFAULT NULL,
			  `postal_code` varchar(50) DEFAULT NULL,
			  `country` varchar(50) DEFAULT NULL,
			  `latitude` varchar(50) DEFAULT NULL,
			  `longitude` varchar(50) DEFAULT NULL,
			  `creator` int(11) NOT NULL DEFAULT '0',
			  `date_created` datetime NOT NULL DEFAULT '0002-11-30 00:00:00',
			  `retired` tinyint(4) NOT NULL DEFAULT '0',
			  `retired_by` int(11) DEFAULT NULL,
			  `date_retired` datetime DEFAULT NULL,
			  `retire_reason` varchar(255) DEFAULT NULL,
			  `parent_household_location` int(11) DEFAULT NULL,
			  `uuid` char(38) NOT NULL,
			  PRIMARY KEY (`household_location_id`),
			  UNIQUE KEY `household_location_uuid_index` (`uuid`),
			  KEY `name_of_household_location` (`name`),
			  KEY `household_retired_status` (`retired`),
			  KEY `user_who_created_household_location` (`creator`),
			  KEY `user_who_retired_household_location` (`retired_by`),
			  CONSTRAINT `user_who_created_household_location` FOREIGN KEY (`creator`) REFERENCES `users` (`user_id`),
			  CONSTRAINT `user_who_retired_household_location` FOREIGN KEY (`retired_by`) REFERENCES `users` (`user_id`)
			) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;
			
			
			CREATE TABLE `household_location_level` (
				`household_location_level_id` int(11) NOT NULL AUTO_INCREMENT,
				`name` varchar(160) DEFAULT NULL,
				`parent_level_id` int(11) DEFAULT NULL,
				`household_location_field` varchar(50) DEFAULT NULL,
				`uuid` char(38) NOT NULL,
				`required` tinyint(1) NOT NULL DEFAULT '0',
				PRIMARY KEY (`household_location_level_id`),
				UNIQUE KEY `parent_level_id_unique_loc` (`parent_level_id`),
				KEY `household_location_field_unique` (`household_location_field`),
				CONSTRAINT `parent_level_loc` FOREIGN KEY (`parent_level_id`) REFERENCES `household_location_level` (`household_location_level_id`)
			) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;
			
			CREATE TABLE `household_location_entry` (
				`household_location_entry_id` int(11) NOT NULL AUTO_INCREMENT,
				`name` varchar(160) NOT NULL,
				`level_id` int(11) NOT NULL,
				`parent_id` int(11) DEFAULT NULL,
				`user_generated_id` varchar(11) DEFAULT NULL,
				`latitude` double DEFAULT NULL,
				`longitude` double DEFAULT NULL,
				`elevation` double DEFAULT NULL,
				`uuid` char(38) NOT NULL,
				PRIMARY KEY (`household_location_entry_id`),
				KEY `parent_name_loci` (`parent_id`,`name`(20)),
				KEY `level_name` (`level_id`,`name`(20)),
				CONSTRAINT `level_to_level_loci` FOREIGN KEY (`level_id`) REFERENCES `household_location_level` (`household_location_level_id`),
				CONSTRAINT `parent_to_parent_loci` FOREIGN KEY (`parent_id`) REFERENCES `household_location_entry` (`household_location_entry_id`)
			) ENGINE=InnoDB AUTO_INCREMENT=341 DEFAULT CHARSET=utf8;
			
			
			CREATE TABLE `household_encounter_type` (
			  `household_encounter_type_id` int(11) NOT NULL AUTO_INCREMENT,
			  `name` varchar(50) NOT NULL DEFAULT '',
			  `description` text,
			  `creator` int(11) NOT NULL DEFAULT '0',
			  `date_created` datetime NOT NULL DEFAULT '0002-11-30 00:00:00',
			  `retired` smallint(6) NOT NULL DEFAULT '0',
			  `retired_by` int(11) DEFAULT NULL,
			  `date_retired` datetime DEFAULT NULL,
			  `retire_reason` varchar(255) DEFAULT NULL,
			  `uuid` char(38) NOT NULL,
			  PRIMARY KEY (`household_encounter_type_id`),
			  UNIQUE KEY `household_encounter_type_uuid_index` (`uuid`),
			  KEY `household_retired_status` (`retired`),
			  KEY `user_who_created_household_type` (`creator`),
			  KEY `user_who_retired_household_encounter_type` (`retired_by`),
			  CONSTRAINT `user_who_created_household_type` FOREIGN KEY (`creator`) REFERENCES `users` (`user_id`),
			  CONSTRAINT `user_who_retired_household_encounter_type` FOREIGN KEY (`retired_by`) REFERENCES `users` (`user_id`)
			) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8;

			CREATE TABLE `household_encounter` (
			  `household_encounter_id` int(11) NOT NULL AUTO_INCREMENT,
			  `household_encounter_type` int(11) NOT NULL,
			  `household_group_uuid` char(38) NOT NULL,
			  `provider_id` int(11) NOT NULL DEFAULT '0',
			  `location_uuid` char(38) DEFAULT NULL,
			  `form_id` int(11) DEFAULT NULL,
			  `household_encounter_datetime` datetime NOT NULL DEFAULT '0002-11-30 00:00:00',
			  `creator` int(11) NOT NULL DEFAULT '0',
			  `date_created` datetime NOT NULL DEFAULT '0002-11-30 00:00:00',
			  `voided` smallint(6) NOT NULL DEFAULT '0',
			  `voided_by` int(11) DEFAULT NULL,
			  `date_voided` datetime DEFAULT NULL,
			  `void_reason` varchar(255) DEFAULT NULL,
			  `uuid` char(38) NOT NULL,
			  `changed_by` int(11) DEFAULT NULL,
			  `date_changed` datetime DEFAULT NULL,
			  PRIMARY KEY (`household_encounter_id`),
			  UNIQUE KEY `household_encounter_uuid_index` (`uuid`),
			  KEY `household_encounter_ibfk_1` (`creator`),
			  KEY `household_encounter_type_id` (`household_encounter_type`),
			  KEY `household_encounter_form` (`form_id`),
			  KEY `household_encounter_location` (`location_uuid`),
			  KEY `household_encounter_patient` (`household_group_uuid`),
			  KEY `user_who_voided_household_encounter` (`voided_by`),
			  KEY `household_encounter_changed_by` (`changed_by`),
			  KEY `household_encounter_provider` (`provider_id`),
			  KEY `household_encounter_datetime_idx` (`household_encounter_datetime`),
			  CONSTRAINT `household_encounter_changed_by` FOREIGN KEY (`changed_by`) REFERENCES `users` (`user_id`),
			  CONSTRAINT `household_encounter_form` FOREIGN KEY (`form_id`) REFERENCES `form` (`form_id`),
			  CONSTRAINT `household_encounter_ibfk_1` FOREIGN KEY (`creator`) REFERENCES `users` (`user_id`),
			  CONSTRAINT `household_encounter_location` FOREIGN KEY (`location_uuid`) REFERENCES `household_location` (`uuid`),
			  CONSTRAINT `household_encounter_patient` FOREIGN KEY (`household_group_uuid`) REFERENCES `household` (`uuid`) ON UPDATE CASCADE,
			  CONSTRAINT `household_encounter_provider` FOREIGN KEY (`provider_id`) REFERENCES `person` (`person_id`),
			  CONSTRAINT `household_encounter_type_id` FOREIGN KEY (`household_encounter_type`) REFERENCES `household_encounter_type` (`household_encounter_type_id`),
			  CONSTRAINT `user_who_voided_household_encounter` FOREIGN KEY (`voided_by`) REFERENCES `users` (`user_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE `household_obs` (
			  `household_obs_id` int(11) NOT NULL AUTO_INCREMENT,
			  `household_group_uuid` char(38) NOT NULL,
			  `concept_id` int(11) NOT NULL DEFAULT '0',
			  `household_encounter_uuid` char(38) DEFAULT NULL,
			  `household_obs_datetime` datetime NOT NULL DEFAULT '0002-11-30 00:00:00',
			  `location_uuid` char(38) DEFAULT NULL,
			  `household_obs_group_uuid` char(38) DEFAULT NULL,
			  `value_group_id` int(11) DEFAULT NULL,
			  `value_boolean` tinyint(4) DEFAULT NULL,
			  `value_coded` int(11) DEFAULT NULL,
			  `value_coded_name_id` int(11) DEFAULT NULL,
			  `value_datetime` datetime DEFAULT NULL,
			  `value_numeric` double DEFAULT NULL,
			  `value_modifier` varchar(2) DEFAULT NULL,
			  `value_text` text,
			  `date_started` datetime DEFAULT NULL,
			  `date_stopped` datetime DEFAULT NULL,
			  `comments` varchar(255) DEFAULT NULL,
			  `creator` int(11) NOT NULL DEFAULT '0',
			  `date_created` datetime NOT NULL DEFAULT '0002-11-30 00:00:00',
			  `voided` smallint(6) NOT NULL DEFAULT '0',
			  `voided_by` int(11) DEFAULT NULL,
			  `date_voided` datetime DEFAULT NULL,
			  `void_reason` varchar(255) DEFAULT NULL,
			  `uuid` char(38) NOT NULL,
			  PRIMARY KEY (`household_obs_id`),
			  UNIQUE KEY `household_obs_uuid_index` (`uuid`),
			  KEY `household_obs_concept` (`concept_id`),
			  KEY `household_obs_enterer` (`creator`),
			  KEY `household_encounter_observations` (`household_encounter_uuid`),
			  KEY `household_obs_location` (`location_uuid`),
			  KEY `household_obs_grouping_uuid` (`household_obs_group_uuid`),
			  KEY `household_group_obs` (`household_group_uuid`),
			  KEY `household_answer_concept` (`value_coded`),
			  KEY `household_obs_name_of_coded_value` (`value_coded_name_id`),
			  KEY `household_user_who_voided_obs` (`voided_by`),
			  KEY `household_obs_datetime` (`household_obs_datetime`),
			  CONSTRAINT `household_answer_concept` FOREIGN KEY (`value_coded`) REFERENCES `concept` (`concept_id`),
			  CONSTRAINT `household_encounter_observations` FOREIGN KEY (`household_encounter_uuid`) REFERENCES `household_encounter` (`uuid`),
			  CONSTRAINT `household_obs_concept` FOREIGN KEY (`concept_id`) REFERENCES `concept` (`concept_id`),
			  CONSTRAINT `household_obs_enterer` FOREIGN KEY (`creator`) REFERENCES `users` (`user_id`),
			  CONSTRAINT `household_obs_grouping_uuid` FOREIGN KEY (`household_obs_group_uuid`) REFERENCES `household_obs` (`uuid`),
			  CONSTRAINT `household_obs_location` FOREIGN KEY (`location_uuid`) REFERENCES `household_location` (`uuid`),
			  CONSTRAINT `household_obs_name_of_coded_value` FOREIGN KEY (`value_coded_name_id`) REFERENCES `concept_name` (`concept_name_id`),
			  CONSTRAINT `household_group_obs` FOREIGN KEY (`household_group_uuid`) REFERENCES `household` (`uuid`) ON UPDATE CASCADE,
			  CONSTRAINT `household_user_who_voided_obs` FOREIGN KEY (`voided_by`) REFERENCES `users` (`user_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
		</sql>
	</diff>
	<diff>
		<version>1.0.2</version>
		<author>Jonah S. Mwogi</author>
		<date>Oct 1, 2011</date>
		<description>
			Drop constraint to allow for household grouping uuid
		</description>
		<sql>
			ALTER TABLE `household_obs` DROP KEY `household_obs_grouping_uuid`;
		</sql>
	</diff>
	<diff>
		<version>1.0.3</version>
		<author>Jonah S. Mwogi</author>
		<date>Nov 29, 2011</date>
		<description>
			Add the collumn uuid to household_membership table
		</description>
		<sql>
			ALTER TABLE `household_membership` ADD `uuid` char(38) NOT NULL;
		</sql>
	</diff>
</sqldiff>
